// Prisma schema for MongoDB – shared across api-gateway, auth-service, user-service
// MongoDB: use Prisma 6.x only (v7 does not support MongoDB yet). Keep url in datasource for v6.
generator client {
  provider = "prisma-client-js"
  output   = "../libs/prisma/generated"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userNumber String   @unique // SP-XXXXX (5 chars after SP-)
  email      String   @unique
  password   String
  firstName  String
  lastName   String
  nin        String   @unique
  picture    String?
  role       String   @default("Customer")
  verified   Boolean  @default(false)
  suspended  Boolean  @default(false) // when true, user cannot log in
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// 4-digit login codes sent to email; verify before issuing JWT
model LoginCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String   // 4 digits
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// 4-digit codes for password reset (forgot password flow)
model PasswordResetCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  token     String   @unique // client stores this; used to validate reset with code
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Pending registration: after verify code we create User + Wallet
model PendingRegistration {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String
  code          String
  expiresAt     DateTime
  passwordHash  String
  firstName     String
  lastName      String
  nin           String
  picture       String?
  createdAt     DateTime @default(now())
}

model Wallet {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  balance   Float    @default(0)
  currency  String   @default("NGN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Loan {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  userId        String          @db.ObjectId
  amount        Float
  purpose       String?
  status        String          // PENDING | APPROVED | REJECTED | DISBURSED | REPAID
  dueDate       DateTime?
  disbursedAt   DateTime?
  amountRepaid  Float           @default(0)
  repaidAt      DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  repayments    LoanRepayment[]
}

// One record per repayment (for history)
model LoanRepayment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  loanId    String   @db.ObjectId
  loan      Loan     @relation(fields: [loanId], references: [id])
  userId    String   @db.ObjectId // denormalized for easy "repayments by user" queries
  amount    Float
  repaidAt  DateTime @default(now())
}

// Funding providers – supply capital for loans; have wallet and credit history
model Provider {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  providerNumber   String        @unique // SP-XXXXX
  name             String
  email            String?
  agreedAmount     Float?        // agreed capital amount (e.g. NGN) they provide
  percentageToAdd  Float         @default(0) // agreed % added on their share of repayments
  agreedAt         DateTime?     // when the agreement was made
  agreedTerms      String?       // optional agreed terms / notes
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  loanFundings     LoanFunding[]
}

model ProviderWallet {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  providerId  String   @unique @db.ObjectId
  balance     Float    @default(0)   // amount so far returned to provider
  totalFunded Float    @default(0)   // total amount they have brought/funded
  currency    String   @default("NGN")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Which provider funded how much for which loan (filled when loan is disbursed)
model LoanFunding {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  providerId String   @db.ObjectId
  loanId     String   @db.ObjectId
  amount     Float    // amount this provider supplied for this loan
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id])
}

// History of credits to provider (when repayments are allocated to them)
model ProviderCredit {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  providerId String   @db.ObjectId
  amount     Float
  loanId     String?  @db.ObjectId
  createdAt  DateTime @default(now())
}

model Employee {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  employeeNumber String   @unique // SP-XXXXX (5 chars after SP-)
  email          String   @unique
  password       String
  firstName      String
  lastName       String
  role           String   // Super Admin | Finance | Customer Support | etc.
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Admin user activity – each record has an id and is attached to a user (admin)
model AdminActivity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId // User.id (admin user)
  action    String
  ip        String?
  createdAt DateTime @default(now())
}
